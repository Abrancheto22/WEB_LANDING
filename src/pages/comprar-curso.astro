---
import Layout from '../layouts/Layout.astro';
import Imagen from '../assets/QR2.jpg';
// Datos de los cursos
const cursos = [
  { 
    title: "Tecnologías Digitales en el Aula",
    description: "Aprende a integrar herramientas digitales en tus clases para mejorar el aprendizaje de tus estudiantes.",
    price: "149",
    rating: 5.0,  
    icon: "laptop",
    badge: "Más popular",
    color: "yellow"
  },
  {
    title: "Neurociencia y Aprendizaje",
    description: "Conoce cómo funciona el cerebro durante el aprendizaje y aplica estrategias basadas en neurociencia.",
    price: "129",
    rating: 4.7,
    icon: "brain",
    color: "blue"
  },
  {
    title: "Aula Invertida (Flipped Classroom)",
    description: "Transforma tu metodología de enseñanza con el modelo de aula invertida para un aprendizaje más activo.",
    price: "159",
    rating: 4.9,
    icon: "rocket",
    badge: "Nuevo",
    color: "purple"
  }
];

interface Curso {
  title: string;
  description: string;
  price: string;
  rating: number;
  icon: string;
  badge?: string;
  color: string;
}

const { searchParams } = Astro.url;


// Extraemos los parámetros de la URL
const selectedCourseTitle = searchParams.get('title');
const selectedCourse: Curso | null = selectedCourseTitle 
  ? cursos.find((c: Curso) => c.title === selectedCourseTitle) || null
  : null;

const course = selectedCourse || {
  title: 'Selecciona un curso',
  description: 'Por favor selecciona un curso para continuar',
  price: '0',
  rating: 0,
  icon: 'book',
  color: 'indigo'
} as Curso;

const getBgColor = () => {
  switch (course.color) {
    case "indigo":
      return "bg-gradient-to-r from-indigo-600 to-indigo-700";
    case "blue":
      return "bg-gradient-to-r from-blue-600 to-blue-700";
    case "purple":
      return "bg-gradient-to-r from-purple-600 to-purple-700";
    case "yellow":
      return "bg-gradient-to-r from-yellow-600 to-yellow-700";
    default:
      return "bg-gradient-to-r from-indigo-600 to-indigo-700";
  }
};

const getIcon = () => {
  switch (course.color) {
    case "indigo":
      return "fas fa-laptop";
    case "blue":
      return "fas fa-brain";
    case "purple":
      return "fas fa-rocket";
    case "yellow":
      return "fas fa-star";
    default:
      return "fas fa-laptop";
  }
};

const getIconColor = () => {
  switch (course.color) {
    case "yellow":
      return "text-yellow-600";
    default:
      return "text-gray-600";
  }
};
---




<Layout title={course.title}>
  <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-16 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
      <!-- Tarjeta principal con efecto de elevación -->
      <div class="bg-white/95 backdrop-blur-lg shadow-xl rounded-3xl overflow-hidden border border-gray-100">
        <!-- Encabezado con gradiente -->
        <div class={`${getBgColor()} px-8 py-6 text-white`}>
          <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div class="space-y-2">
              <h1 class="text-3xl md:text-4xl font-extrabold text-white mb-2">
                {course.title}
              </h1>
              <p class="text-indigo-100">{course.description}</p>
            </div>
            <div class="mt-4 md:mt-0">
              <i class="${getIcon()} ${getIconColor()} text-4xl"></i>
            </div>
          </div>
        </div>

        <!-- Imagen representativa del curso -->
        <div class="w-full h-64 overflow-hidden">
          <img 
            src="/src/assets/tecnologia.jpg" 
            alt="Tecnología educativa"
            class="w-full h-full object-cover"
          />
        </div>

        <!-- Contenido principal -->
        <div class="p-8">
          <form id="pagoForm" class="space-y-6" onsubmit="return enviarComprobante(event)">
                    <!-- Campo oculto para el curso seleccionado -->
                        <input type="hidden" id="cursoNombre" name="curso" value={selectedCourse?.title || ''} />
                        <input type="hidden" id="precioCursoInput" name="precio" value={selectedCourse?.price || '0'} />
                        <!-- Sección de información personal -->
                    <div class="bg-white p-6 rounded-xl border border-gray-200 mb-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Información personal</h3>
              <div class="space-y-4">
                
                <!-- Nombre completo -->
                <div>
                  <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre completo</label>
                  <input 
                    type="text" 
                    id="nombres" 
                    name="nombres" 
                    required
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    placeholder="Ingrese su nombre completo"
                  >
                </div>

                <!-- Apellidos -->
                <div>
                  <label for="apellidos" class="block text-sm font-medium text-gray-700 mb-1">Apellidos</label>
                  <input 
                    type="text" 
                    id="apellidos" 
                    name="apellidos" 
                    required
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    placeholder="Ingrese sus apellidos"
                  >
                </div>

                <!-- DNI y Teléfono -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="dni" class="block text-sm font-medium text-gray-700 mb-1">DNI</label>
                    <input 
                      type="text" 
                      id="dni" 
                      name="dni"
                      maxlength="8"
                      required
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                      placeholder="Ingrese su DNI"
                    >
                  </div>
                  <div>
                    <label for="telefono" class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                    <input 
                      type="tel" 
                      id="telefono" 
                      name="telefono"
                      required
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                      placeholder="+51 987 654 321"
                    >
                  </div>
                </div>

                <!-- Correo electrónico y Dirección -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Correo electrónico</label>
                    <input 
                      type="email" 
                      id="correo" 
                      name="correo" 
                      required
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                      placeholder="ejemplo@correo.com"
                    >
                  </div>
                  <div>
                    <label for="direccion" class="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
                    <input 
                      type="text" 
                      id="direccion" 
                      name="direccion"
                      required
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                      placeholder="Ingrese su dirección"
                    >
                  </div>
                </div>

              </div>
            </div>


            <!-- Sección de información del curso -->
            <div class="bg-gray-50 p-6 rounded-xl">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Información del curso</h3>
              <div class="space-y-4">
                <div class="space-y-2">
                  <label for="cursoSelect" class="block text-sm font-medium text-gray-700">Seleccionar curso</label>
                  <select 
                    id="cursoSelect" 
                    class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                  >
                    <option value="" disabled={!selectedCourse} selected={!selectedCourse}>
                      {selectedCourse ? 'Cambiar curso' : 'Selecciona un curso'}
                    </option>
                    {cursos && Array.isArray(cursos) && cursos.map((curso: Curso) => (
                      <option 
                        value={curso.title} 
                        data-price={curso.price}
                        selected={selectedCourse?.title === curso.title}
                      >
                        {curso.title} - ${curso.price}
                      </option>
                    ))}
                  </select>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Precio:</span>
                  <span class="font-bold text-indigo-600" id="precioCurso">$0.00</span>
                </div>
              </div>
            </div>

            <!-- Sección de método de pago -->
            <div class="bg-white p-6 rounded-xl border border-gray-200">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Método de pago</h3>
              <div class="space-y-4">
                <select name="metodoPago" id="metodoPago" onchange="handlePaymentMethodChange()" 
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                  <option value="">Seleccione un método de pago</option>
                  <option value="deposito">Depósito Bancario</option>
                  <option value="pago_movil">Pago Móvil</option>
                </select>

                <!-- Campos para depósito bancario -->
                <div id="bancoDiv" class="hidden">
                  <label for="banco" class="block text-sm font-medium text-gray-700 mb-1">Banco</label>
                  <select id="banco" name="banco" class="w-full p-3 border border-gray-300 rounded-lg">
                    <option value="">Seleccione un banco</option>
                    <option value="BCP">BCP</option>
                    <option value="Interbank">Interbank</option>
                    <option value="BBVA">BBVA</option>
                  </select>
                </div>

                <div id="numeroCuentaDiv" class="hidden">
                  <label for="numeroCuenta" class="block text-sm font-medium text-gray-700 mb-1">Número de cuenta</label>
                  <input type="text" id="numeroCuenta" name="numeroCuenta" 
                    class="w-full p-3 border border-gray-300 rounded-lg" 
                    placeholder="Ingrese el número de cuenta">
                </div>

                <!-- Imagen de comprobante -->
                <div id="imagenComprobanteDiv" class="hidden">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Subir comprobante de depósito</label>
                  <div id="dropZoneDeposito" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-indigo-500 transition-colors duration-200">
                    <div class="space-y-1 text-center">
                      <svg id="uploadIconDeposito" class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                      <div id="fileInfoDeposito" class="hidden">
                        <p id="fileNameDeposito" class="text-sm font-medium text-gray-700 truncate"></p>
                        <p id="fileSizeDeposito" class="text-xs text-gray-500"></p>
                        <button type="button" id="removeFileDeposito" class="mt-1 text-xs text-red-600 hover:text-red-500">
                          Eliminar archivo
                        </button>
                      </div>
                      <div id="uploadPromptDeposito">
                        <div class="flex flex-col items-center text-sm text-gray-600">
                          <label for="comprobante-deposito" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none">
                            <span>Subir comprobante</span>
                            <input id="comprobante-deposito" name="comprobanteDeposito" type="file" class="sr-only" accept="image/*,.pdf">
                          </label>
                          <p class="mt-1">o arrastra y suelta</p>
                        </div>
                        <p class="text-xs text-gray-500">
                          PNG, JPG, PDF hasta 10MB
                        </p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Imagen de Yape -->
                <div id="imagenYapeDiv" class="hidden">
                  <div class="text-center">
                    <p class="text-sm text-gray-600 mb-4">Escanea el código QR con tu aplicación de Yape</p>
                    <div class="w-48 h-48 mx-auto bg-white p-4 rounded-lg border border-gray-200">
                      <img src={Imagen.src} alt="Código QR de Yape" class="w-full h-full object-contain">
                    </div>
                  </div>
                </div>

                <!-- Comprobante de Pago Móvil -->
                <div id="comprobantePagoMovilDiv" class="hidden">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Subir comprobante de pago móvil</label>
                  <div id="dropZone" class="mt-2 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-indigo-500 transition-colors duration-200">
                    <div class="space-y-1 text-center">
                      <svg id="uploadIcon" class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                      <div id="fileInfo" class="hidden">
                        <p id="fileName" class="text-sm font-medium text-gray-700 truncate"></p>
                        <p id="fileSize" class="text-xs text-gray-500"></p>
                        <button type="button" id="removeFile" class="mt-1 text-xs text-red-600 hover:text-red-500">
                          Eliminar archivo
                        </button>
                      </div>
                      <div id="uploadPrompt">
                        <div class="flex flex-col items-center text-sm text-gray-600">
                          <label for="comprobante-pago-movil" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none">
                            <span>Subir comprobante</span>
                            <input id="comprobante-pago-movil" name="comprobantePagoMovil" type="file" class="sr-only" accept="image/*,.pdf" required>
                          </label>
                          <p class="mt-1">o arrastra y suelta</p>
                        </div>
                        <p class="text-xs text-gray-500">
                          PNG, JPG, PDF hasta 10MB
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Botones de acción -->
            <div class="flex flex-col sm:flex-row gap-4 justify-between pt-4">
              <button 
                type="button"
                onclick="window.history.back()"
                class="w-full sm:w-auto px-6 py-3.5 border border-gray-300 rounded-xl shadow-sm text-base font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 flex items-center justify-center gap-2 hover:shadow-md hover:scale-105 transform"
              >
                <i class="fas fa-arrow-left mr-2"></i>
                Volver atrás
              </button>
              <div class="space-y-4">
                <div id="capturaContainer" class="hidden"></div>
                <button 
                  type="submit" 
                  class="w-full sm:w-auto px-8 py-3.5 border border-transparent rounded-xl shadow-sm text-base font-medium text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 transform hover:scale-110 hover:shadow-lg active:scale-95 flex items-center justify-center gap-2"
                  id="submitButton"
                >
                  <span class="flex items-center">
                    <i class="fas fa-lock mr-2"></i>
                    <span>Confirmar y pagar</span>
                  </span>
                  <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white hidden" id="spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </button>
              </div>
            </div>
          </form>

          <!-- Vista previa de la boleta -->
          <div class="mt-8 bg-white rounded-lg shadow-lg p-6 space-y-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Vista previa de la boleta</h3>
            <div class="border-b pb-4">
              <div class="flex justify-between">
                <span class="text-gray-600">Curso seleccionado:</span>
                <span class="font-semibold" id="boleta-curso">{course.title}</span>
              </div>
              <div class="flex justify-between mt-2">
                <span class="text-gray-600">Precio:</span>
                <span class="font-semibold" id="boleta-precio">${selectedCourse ? selectedCourse.price + '.00' : '0.00'}</span>
              </div>
            </div>
            <div class="border-b pb-4">
              <div class="flex justify-between">
                <span class="text-gray-600">Método de pago:</span>
                <span class="font-semibold" id="boleta-metodo">No seleccionado</span>
              </div>
              <div id="boleta-detalle" class="hidden mt-2">
                <div class="flex justify-between">
                  <span class="text-gray-600">Banco:</span>
                  <span class="font-semibold" id="boleta-banco">No seleccionado</span>
                </div>
                <div class="flex justify-between mt-2">
                  <span class="text-gray-600">Número de cuenta:</span>
                  <span class="font-semibold" id="boleta-numero">No seleccionado</span>
                </div>
              </div>
              <div id="yape-qr" class="hidden mt-4">
                <h4 class="text-sm font-medium text-gray-700 mb-2">QR de Yape</h4>
                <div class="w-48 h-48 mx-auto">
                  <img src={Imagen.src} alt="QR de Yape" class="w-full h-full object-contain" />
                </div>
              </div>
            </div>
            <div class="pt-4">
              <h4 class="text-sm font-medium text-gray-700 mb-2">Total a pagar:</h4>
              <div class="text-2xl font-bold text-indigo-600" id="boleta-total">${selectedCourse ? '$' + selectedCourse.price + '.00' : '$0.00'}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  // Declaración de tipos para html2canvas
  declare const html2canvas: (element: HTMLElement, options?: any) => Promise<HTMLCanvasElement>;
  // Función para actualizar el precio cuando se selecciona un curso
  function actualizarPrecio() {
    const selectorCurso = document.getElementById('cursoSelect') as HTMLSelectElement | null;
    const precioElemento = document.getElementById('precioCurso');
    const boletaPrecio = document.getElementById('boleta-precio');
    const boletaCurso = document.getElementById('boleta-curso');
    const boletaTotal = document.getElementById('boleta-total');
    
    if (selectorCurso && precioElemento && boletaPrecio && boletaCurso && boletaTotal) {
      const opcionSeleccionada = selectorCurso.options[selectorCurso.selectedIndex];
      const precio = opcionSeleccionada?.dataset.price || '0';
      const nombreCurso = opcionSeleccionada?.value || '';
      
      // Actualizar el precio en el formulario
      precioElemento.textContent = `$${precio}.00`;
      
      // Actualizar la vista previa de la boleta
      boletaPrecio.textContent = `$${precio}.00`;
      boletaTotal.textContent = `$${precio}.00`;
      
      if (nombreCurso) {
        boletaCurso.textContent = nombreCurso;
      }
    }
  }

  // Configurar el evento de cambio para el selector de cursos
  document.addEventListener('DOMContentLoaded', () => {
    const selectorCurso = document.getElementById('cursoSelect') as HTMLSelectElement | null;
    if (selectorCurso) {
      selectorCurso.addEventListener('change', actualizarPrecio);
      // Actualizar el precio inicial si hay un curso seleccionado por defecto
      if (selectorCurso.value) {
        actualizarPrecio();
      }
    }

    // Configurar el manejador de cambio de método de pago
    const metodoPago = document.getElementById('metodoPago');
    if (metodoPago) {
      metodoPago.addEventListener('change', handlePaymentMethodChange);
      // Disparar el evento change para mostrar/ocultar los campos correspondientes
      metodoPago.dispatchEvent(new Event('change'));
    }

    // Configurar la carga de archivos para ambos métodos de pago
    setupFileUpload();
    setupDepositoFileUpload();
  });

  const handlePaymentMethodChange = () => {
    const selectElement = document.querySelector<HTMLSelectElement>('select[name="metodoPago"]');
    if (!selectElement) return;
    
    const method = selectElement.value;
    const numeroCuentaDiv = document.getElementById('numeroCuentaDiv');
    const bancoDiv = document.getElementById('bancoDiv');
    const imagenComprobanteDiv = document.getElementById('imagenComprobanteDiv');
    const boletaDetalle = document.getElementById('boleta-detalle');
    const yapeQr = document.getElementById('yape-qr');
    const imagenYapeDiv = document.getElementById('imagenYapeDiv');
    const boletaMetodo = document.getElementById('boleta-metodo');
    const comprobantePagoMovilDiv = document.getElementById('comprobantePagoMovilDiv');
    
    if (!numeroCuentaDiv || !bancoDiv || !imagenComprobanteDiv || !boletaDetalle || 
        !yapeQr || !imagenYapeDiv || !boletaMetodo || !comprobantePagoMovilDiv) return;

    // Ocultar todos los elementos primero
    numeroCuentaDiv.classList.add('hidden');
    bancoDiv.classList.add('hidden');
    boletaDetalle.classList.add('hidden');
    imagenComprobanteDiv.classList.add('hidden');
    imagenYapeDiv.classList.add('hidden');
    yapeQr.classList.add('hidden');
    comprobantePagoMovilDiv.classList.add('hidden');

    // Mostrar elementos según el método de pago
    if (method === 'deposito') {
      // Para depósito bancario, mostramos el formulario de depósito
      numeroCuentaDiv.classList.remove('hidden');
      bancoDiv.classList.remove('hidden');
      boletaDetalle.classList.remove('hidden');
      imagenComprobanteDiv.classList.remove('hidden');
      boletaMetodo.textContent = 'Depósito Bancario';
    } else if (method === 'pago_movil') {
      // Para pago móvil, mostramos el QR de Yape y el campo de subir comprobante
      imagenYapeDiv.classList.remove('hidden');
      yapeQr.classList.remove('hidden');
      comprobantePagoMovilDiv.classList.remove('hidden');
      boletaMetodo.textContent = 'Pago Móvil';
    } else {
      boletaMetodo.textContent = 'No seleccionado';
    }
  };

  const updateBoletaPreview = () => {
    const bancoSelect = document.querySelector<HTMLSelectElement>('select[name="banco"]');
    const numeroCuentaInput = document.querySelector<HTMLInputElement>('input[name="numeroCuenta"]');
    const boletaBanco = document.getElementById('boleta-banco');
    const boletaNumero = document.getElementById('boleta-numero');
    
    if (bancoSelect && boletaBanco) {
      boletaBanco.textContent = bancoSelect.value || 'No seleccionado';
    } else if (boletaBanco) {
      boletaBanco.textContent = 'No seleccionado';
    }
    
    if (numeroCuentaInput && boletaNumero) {
      boletaNumero.textContent = numeroCuentaInput.value || 'No ingresado';
    } else if (boletaNumero) {
      boletaNumero.textContent = 'No ingresado';
    }
  };

  // Configuración inicial cuando el DOM esté listo
  // Función para formatear el tamaño del archivo
  function formatFileSize(bytes: number) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // Función para configurar la carga de archivos para depósito bancario
  function setupDepositoFileUpload() {
    const fileInput = document.getElementById('comprobante-deposito') as HTMLInputElement | null;
    const dropZone = document.getElementById('dropZoneDeposito');
    const uploadIcon = document.getElementById('uploadIconDeposito') as HTMLImageElement | null;
    const fileInfo = document.getElementById('fileInfoDeposito');
    const fileName = document.getElementById('fileNameDeposito');
    const fileSize = document.getElementById('fileSizeDeposito');
    const uploadPrompt = document.getElementById('uploadPromptDeposito');
    const removeFileBtn = document.getElementById('removeFileDeposito');
    
    // Verificar que todos los elementos necesarios existan
    if (!fileInput || !dropZone || !uploadIcon || !fileInfo || !fileName || !fileSize || !uploadPrompt || !removeFileBtn) {
      console.error('No se pudieron encontrar todos los elementos necesarios para la carga de archivos');
      return;
    }

    // Manejar cambio de archivo
    fileInput.addEventListener('change', (e) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (file) handleFileSelection(file);
    });

    // Verificar que dropZone existe antes de agregar eventos
    if (!dropZone) {
      console.error('Error: No se pudo encontrar el área de arrastrar y soltar');
      return;
    }

    // Manejar arrastrar y soltar
    const eventTypes = ['dragenter', 'dragover', 'dragleave', 'drop'] as const;
    
    eventTypes.forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e: Event) {
      e.preventDefault();
      e.stopPropagation();
    }

    // Solo proceder si dropZone existe
    if (dropZone) {
      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
      });
    }

    function highlight(this: HTMLElement) {
      this.classList.add('border-indigo-500', 'bg-indigo-50');
    }

    function unhighlight(this: HTMLElement) {
      this.classList.remove('border-indigo-500', 'bg-indigo-50');
    }

    // Manejar soltar archivo
    dropZone.addEventListener('drop', (e: DragEvent) => {
      const dt = e.dataTransfer;
      if (dt?.files.length) {
        const input = fileInput as HTMLInputElement;
        if (input) {
          input.files = dt.files;
          handleFileSelection(dt.files[0]);
        }
      }
    });

    // Manejar la selección de archivo
    function handleFileSelection(file: File) {
      // Validar tipo de archivo
      const validTypes = ['image/jpeg', 'image/png', 'application/pdf'];
      if (!validTypes.includes(file.type)) {
        mostrarNotificacion('Tipo de archivo no válido. Sube una imagen (JPG, PNG) o PDF.', 'error');
        return;
      }

      // Validar tamaño (10MB máximo)
      const maxSize = 10 * 1024 * 1024; // 10MB
      if (file.size > maxSize) {
        mostrarNotificacion('El archivo es demasiado grande. El tamaño máximo es 10MB.', 'error');
        return;
      }

      // Verificar que todos los elementos necesarios existan
      if (!fileName || !fileSize || !fileInfo || !uploadPrompt || !uploadIcon) {
        console.error('Error: No se encontraron todos los elementos necesarios');
        return;
      }

      // Actualizar la interfaz
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
      fileInfo.classList.remove('hidden');
      uploadPrompt.classList.add('hidden');
      
      // Mostrar vista previa si es una imagen
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          if (uploadIcon && e.target?.result) {
            uploadIcon.src = e.target.result as string;
            uploadIcon.classList.add('w-24', 'h-24', 'object-cover', 'rounded');
          }
        };
        reader.readAsDataURL(file);
      } else if (uploadIcon) {
        uploadIcon.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9Im5vbmUiIHZpZXdCb3g9IjAgMCAyNCAyNCIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCI+PHBhdGggc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBzdHJva2Utd2lkdGg9IjIiIGQ9IkNNOCAxNnYtMTZhMiAyIDAgMDEyLTJoOGEyIDIgMCAwMTIgMnYxMmEzIDMgMCAwMS0zIDNoLTlsLTQgNHY0eiIvPjwvc3ZnPg==';
        uploadIcon.classList.remove('w-24', 'h-24', 'object-cover', 'rounded');
      }
    }

    // Manejar botón de eliminar archivo
    removeFileBtn.addEventListener('click', () => {
      fileInput.value = '';
      fileInfo.classList.add('hidden');
      uploadPrompt.classList.remove('hidden');
      uploadIcon.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9Im5vbmUiIHZpZXdCb3g9IjAgMCAyNCAyNCIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCI+PHBhdGggc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBzdHJva2Utd2lkdGg9IjIiIGQ9IkNNOCAxNnYtMTZhMiAyIDAgMDEyLTJoOGEyIDIgMCAwMTIgMnYxMmEzIDMgMCAwMS0zIDNoLTlsLTQgNHY0eiIvPjwvc3ZnPg==';
      uploadIcon.classList.remove('w-24', 'h-24', 'object-cover', 'rounded');
    });
  }

  // Función para configurar la carga de archivos para pago móvil
  function setupFileUpload() {
    const fileInputSetup = document.getElementById('comprobante-pago-movil') as HTMLInputElement;
    const dropZone = document.getElementById('dropZone');
    const uploadIcon = document.getElementById('uploadIcon');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const uploadPrompt = document.getElementById('uploadPrompt');
    const removeFileBtn = document.getElementById('removeFile');
    
    if (!fileInputSetup || !dropZone || !uploadIcon || !fileInfo || !fileName || !fileSize || !uploadPrompt || !removeFileBtn) return;

    // Manejar el cambio en el input de archivo
    fileInputSetup.addEventListener('change', (e) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (file) handleFileSelection(file);
    });

    // Manejar el arrastrar y soltar
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e: Event) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
      if (dropZone) {
        dropZone.classList.add('border-indigo-500', 'bg-indigo-50');
      }
    }

    function unhighlight() {
      if (dropZone) {
        dropZone.classList.remove('border-indigo-500', 'bg-indigo-50');
      }
    }

    // Manejar la caída de archivos
    dropZone.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      if (dt?.files.length) {
const input = document.getElementById('comprobante-pago-movil') as HTMLInputElement;
if (input) {
  input.files = dt.files;
}
        handleFileSelection(dt.files[0]);
      }
    });

    // Manejar la eliminación del archivo
    removeFileBtn.addEventListener('click', () => {
      const fileInput = document.getElementById('comprobante-pago-movil') as HTMLInputElement;
      if (fileInput) {
        fileInput.value = '';
      }
      uploadPrompt.classList.remove('hidden');
      fileInfo.classList.add('hidden');
      dropZone.classList.remove('border-green-500');
    });

    function handleFileSelection(file: File) {
      // Validar tipo de archivo
      const validTypes = ['image/jpeg', 'image/png', 'application/pdf'];
      if (!validTypes.includes(file.type)) {
        mostrarNotificacion('Tipo de archivo no válido. Por favor, sube una imagen (JPG, PNG) o un PDF.', 'error');
        return;
      }

      // Validar tamaño del archivo (10MB máximo)
      const maxSize = 10 * 1024 * 1024; // 10MB
      if (file.size > maxSize) {
        mostrarNotificacion('El archivo es demasiado grande. El tamaño máximo permitido es 10MB.', 'error');
        return;
      }

      // Mostrar información del archivo
      if (fileName) {
        fileName.textContent = file.name;
      }
      if (fileSize) {
        fileSize.textContent = formatFileSize(file.size);
      }
      
      // Actualizar la interfaz
      if (uploadPrompt) {
        uploadPrompt.classList.add('hidden');
      }
      if (fileInfo) {
        fileInfo.classList.remove('hidden');
      }
      if (dropZone) {
        dropZone.classList.add('border-green-500');
      }
      
      // Mostrar vista previa si es una imagen
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          if (uploadIcon) {
            uploadIcon.setAttribute('src', e.target?.result as string);
          }
          if (uploadIcon) {
            uploadIcon.classList.remove('text-gray-400');
          }
          if (uploadIcon) {
            uploadIcon.classList.add('w-24', 'h-24', 'object-cover', 'rounded');
          }
        };
        reader.readAsDataURL(file);
      }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Inicializar el método de pago
    handlePaymentMethodChange();
    
    // Configurar el manejador de subida de archivos
    setupFileUpload();
    
    // Configurar el evento change para el select de método de pago
    const metodoSelect = document.querySelector<HTMLSelectElement>('select[name="metodoPago"]');
    if (metodoSelect) {
      metodoSelect.addEventListener('change', handlePaymentMethodChange);
    }

    // Configurar eventos para actualizar la vista previa
    const bancoSelect = document.querySelector<HTMLSelectElement>('select[name="banco"]');
    const numeroCuentaInput = document.querySelector<HTMLInputElement>('input[name="numeroCuenta"]');

    if (bancoSelect) bancoSelect.addEventListener('change', updateBoletaPreview);
    if (numeroCuentaInput) numeroCuentaInput.addEventListener('input', updateBoletaPreview);

    // Configurar el envío del formulario
    const form = document.getElementById('pagoForm');
      if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitButton = document.getElementById('submitButton') as HTMLButtonElement | null;
        const spinner = document.getElementById('spinner');

        if (submitButton && spinner) {
          submitButton.disabled = true;
          spinner.classList.remove('hidden');
        }

        const formData = new FormData(form as HTMLFormElement);

        // Agregar curso y precio del select
        const cursoSelect = document.getElementById('cursoSelect') as HTMLSelectElement | null;
        if (cursoSelect) {
          const selectedOption = cursoSelect.options[cursoSelect.selectedIndex];
          const precio = selectedOption?.getAttribute('data-price') || '0';
          formData.set('curso', selectedOption?.value || '');
          formData.set('precio', precio);
        }

        try {
          const response = await fetch('http://localhost:8080/api/pagos', {
            method: 'POST',
            body: formData
          });

          if (response.ok) {
            const result = await response.json();
          
            console.log(result);
            (form as HTMLFormElement).reset(); // Limpiar form si deseas
            window.location.href = 'http://localhost:4321';
          } else {
            const errorText = await response.text();
         
            console.error(errorText);
            window.location.href = 'http://localhost:4321';
          }
        } catch (error) {
          console.error('Error en la solicitud:', error);
          window.location.href = 'http://localhost:4321';
        } finally {
          if (submitButton && spinner) {
            submitButton.disabled = false;
            spinner.classList.add('hidden');
          }
        }
      });
    }

    // Inicializar la vista previa
    updateBoletaPreview();
  });
  // Función para capturar la vista previa de la boleta
  async function capturarBoleta() {
    const boleta = document.getElementById('vista-previa-boleta');
    const capturaContainer = document.getElementById('capturaContainer');
    
    if (!boleta || !capturaContainer) return null;
    
    try {
      // Usamos html2canvas para capturar el contenido de la boleta
      const canvas = await html2canvas(boleta, {
        scale: 2, // Mejor calidad
        useCORS: true,
        logging: false,
        backgroundColor: null
      });
      
      // Convertir el canvas a una imagen
      const imagen = canvas.toDataURL('image/png');
      
      // Crear un input oculto con la imagen capturada
      const inputOculto = document.createElement('input');
      inputOculto.type = 'hidden';
      inputOculto.name = 'comprobante';
      inputOculto.value = imagen;
      
      // Limpiar el contenedor y agregar el input oculto
      capturaContainer.innerHTML = '';
      capturaContainer.appendChild(inputOculto);
      
      return imagen;
    } catch (error) {
      console.error('Error al capturar la boleta:', error);
      return null;
    }
  }
  
  // Función para validar email
  function validarEmail(email: string): boolean {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(String(email).toLowerCase());
  }

  // Función para validar teléfono
  function validarTelefono(telefono: string): boolean {
    const re = /^[0-9\s\+\-\(\)]{8,15}$/;
    return re.test(telefono);
  }

  // Función para mostrar mensajes de error
  function mostrarError(mensaje: string, elemento: HTMLElement | null) {
    if (!elemento) return;
    
    // Eliminar mensajes de error previos para este campo
    const errorExistente = elemento.parentElement?.querySelector('.error-mensaje');
    if (errorExistente) errorExistente.remove();
    
    // Crear elemento de error
    const errorElemento = document.createElement('p');
    errorElemento.className = 'mt-1 text-sm text-red-600 error-mensaje';
    errorElemento.textContent = mensaje;
    
    // Insertar después del campo
    elemento.parentNode?.insertBefore(errorElemento, elemento.nextSibling);
    
    // Resaltar campo con error
    elemento.classList.add('border-red-500');
    elemento.classList.remove('border-gray-300');
    
    // Quitar el resaltado cuando se corrija
    const limpiarError = () => {
      const input = elemento as HTMLInputElement | HTMLSelectElement;
      if (input.value) {
        elemento.classList.remove('border-red-500');
        elemento.classList.add('border-gray-300');
        errorElemento.remove();
        elemento.removeEventListener('input', limpiarError);
        elemento.removeEventListener('change', limpiarError);
      }
    };
    
    elemento.addEventListener('input', limpiarError, { once: true });
    elemento.addEventListener('change', limpiarError, { once: true });
  }

  // Función para validar el formulario antes de enviar
  function validarFormulario() {
    const cursoSeleccionado = document.getElementById('cursoSelect');
    const metodoPago = document.getElementById('metodoPago');
    const nombre = document.getElementById('nombre') as HTMLInputElement;
    const email = document.getElementById('email') as HTMLInputElement;
    const telefono = document.getElementById('telefono') as HTMLInputElement;
    
    // Limpiar mensajes de error previos
    document.querySelectorAll('.error-mensaje').forEach(el => el.remove());
    
    let valido = true;
    
    // Validar curso seleccionado
    if (!(cursoSeleccionado as HTMLSelectElement).value) {
      mostrarError('Por favor selecciona un curso', cursoSeleccionado);
      valido = false;
    }
    
    // Validar método de pago
    if (!(metodoPago as HTMLSelectElement).value) {
      mostrarError('Por favor selecciona un método de pago', metodoPago);
      valido = false;
    }
    
    // Validar nombre
    if (!nombre.value.trim()) {
      mostrarError('El nombre es obligatorio', nombre);
      valido = false;
    }
    
    // Validar email
    if (!email.value.trim()) {
      mostrarError('El correo electrónico es obligatorio', email);
      valido = false;
    } else if (!validarEmail(email.value.trim())) {
      mostrarError('Ingresa un correo electrónico válido', email);
      valido = false;
    }
    
    // Validar teléfono
    if (!telefono.value.trim()) {
      mostrarError('El teléfono es obligatorio', telefono);
      valido = false;
    } else if (!validarTelefono(telefono.value.trim())) {
      mostrarError('Ingresa un número de teléfono válido (mínimo 8 dígitos)', telefono);
      valido = false;
    }
    
    return valido;
  }
  
  // Función para mostrar notificación
  function mostrarNotificacion(mensaje: string, tipo: 'exito' | 'error' | 'advertencia' = 'exito') {
    // Eliminar notificaciones previas
    const notificacionesExistentes = document.querySelectorAll('.notificacion-flotante');
    notificacionesExistentes.forEach(el => el.remove());
    
    // Crear elemento de notificación
    const notificacion = document.createElement('div');
    notificacion.className = `notificacion-flotante fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg text-white ${
      tipo === 'exito' ? 'bg-green-500' : 
      tipo === 'error' ? 'bg-red-500' : 'bg-yellow-500'
    } z-50 transform transition-all duration-300 translate-x-0 opacity-100`;
    
    notificacion.innerHTML = `
      <div class="flex items-center">
        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <span>${mensaje}</span>
      </div>
    `;
    
    // Agregar al documento
    document.body.appendChild(notificacion);
    
    // Auto-eliminar después de 5 segundos
    setTimeout(() => {
      notificacion.classList.add('opacity-0', 'translate-x-full');
      setTimeout(() => notificacion.remove(), 300);
    }, 5000);
  }
  
  // Función para manejar el envío del formulario
  async function enviarComprobante(event: Event) {
    event.preventDefault();
    
    // Validar el formulario
    if (!validarFormulario()) {
      // Desplazarse al primer error
      const primerError = document.querySelector('.border-red-500');
      if (primerError) {
        primerError.scrollIntoView({ 
          behavior: 'smooth',
          block: 'center'
        });
      }
      return false;
    }
    
    const botonSubmit = document.getElementById('submitButton') as HTMLButtonElement | null;
    const spinner = document.getElementById('spinner');
    const form = document.getElementById('pagoForm') as HTMLFormElement;
    
    if (!botonSubmit || !form) {
      console.error('Elementos del formulario no encontrados');
      mostrarNotificacion('Error al procesar el formulario', 'error');
      return false;
    }
    
    try {
      // Mostrar spinner y deshabilitar botón
      botonSubmit.disabled = true;
      spinner?.classList.remove('hidden');
      
      // Obtener los datos del formulario
      const formData = new FormData(form);
      const formDataToSend = new FormData();
      
      // Copiar los datos básicos del formulario
      formDataToSend.append('telefono', formData.get('telefono') as string);
      formDataToSend.append('curso', formData.get('curso') as string);
      formDataToSend.append('precio', formData.get('precio') as string);
      formDataToSend.append('nombre', formData.get('nombre') as string);
      formDataToSend.append('email', formData.get('email') as string);
      formDataToSend.append('metodoPago', formData.get('metodoPago') as string);
      
      // Verificar el método de pago
      const metodoPago = formData.get('metodoPago');
      
      if (metodoPago === 'pago_movil') {
        // Para pago móvil, usar el archivo subido
        const fileInput = document.getElementById('comprobante-pago-movil') as HTMLInputElement;
        if (fileInput.files && fileInput.files.length > 0) {
          formDataToSend.append('comprobante', fileInput.files[0]);
          console.log('Comprobante de pago móvil adjuntado:', fileInput.files[0].name);
        } else {
          throw new Error('Por favor, sube el comprobante de pago móvil');
        }
      } else if (metodoPago === 'deposito') {
        // Para depósito bancario, capturar la boleta
        const boleta = document.getElementById('vista-previa-boleta');
        if (!boleta) {
          throw new Error('No se pudo generar la boleta');
        }
        
        try {
          // Capturar la boleta como imagen
          const canvas = await html2canvas(boleta, {
            scale: 2, // Mejor calidad
            useCORS: true,
            logging: true,
            backgroundColor: null
          });
          
          // Convertir el canvas a un blob
          const blob = await new Promise<Blob | null>((resolve) => {
            canvas.toBlob((blob) => resolve(blob), 'image/png');
          });
          
          if (!blob) {
            throw new Error('No se pudo convertir la imagen a blob');
          }
          
          // Crear un archivo a partir del blob
          const fileName = `comprobante-${Date.now()}.png`;
          const file = new File([blob], fileName, { type: 'image/png' });
          
          // Agregar el archivo al FormData
          formDataToSend.append('comprobante', file, fileName);
          console.log('Imagen de boleta adjuntada correctamente:', fileName);
        } catch (error) {
          console.error('Error al capturar la boleta:', error);
          throw new Error('Error al generar el comprobante de pago');
        }
      }
      
      // Enviar los datos al servidor
      const response = await fetch('/api/enviar-whatsapp', {
        method: 'POST',
        body: formDataToSend
      });
      
      const result = await response.json();
      
      if (!response.ok) {
        throw new Error(result.message || 'Error al procesar el pago');
      }
      
      // Mostrar mensaje de éxito
      mostrarNotificacion('¡Pago registrado con éxito! Te enviaremos un mensaje por WhatsApp.', 'exito');
      
      // Limpiar el formulario
      form.reset();
      
      // Redirigir a la página de agradecimiento después de 3 segundos
      setTimeout(() => {
        window.location.href = '/gracias';
      }, 3000);
      
    } catch (error) {
      console.error('Error al procesar el pago:', error);
      const mensajeError = error instanceof Error ? error.message : 'Error al procesar el pago. Por favor, inténtalo de nuevo.';
      mostrarNotificacion(mensajeError, 'error');
    } finally {
      // Restaurar el botón
      if (botonSubmit) botonSubmit.disabled = false;
      if (spinner) spinner.classList.add('hidden');
    }
  }
  
  // Agregar html2canvas al documento
  function cargarHtml2Canvas() {
    return new Promise((resolve) => {
      const script = document.createElement('script');
      script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
      script.onload = resolve;
      document.head.appendChild(script);
    });
  }
  
  // Cargar html2canvas cuando el documento esté listo
  document.addEventListener('DOMContentLoaded', async () => {
    await cargarHtml2Canvas();
    // Inicializar el método de pago
    handlePaymentMethodChange();
    
    // Configurar el evento change para el select de método de pago
    const metodoPago = document.getElementById('metodoPago');
    if (metodoPago) {
      metodoPago.addEventListener('change', handlePaymentMethodChange);
    }
  });

</script>
</Layout>
